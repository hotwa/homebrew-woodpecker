name: Test Formula Build

on:
  pull_request:
    paths:
      - 'Formula/**'
  push:
    branches:
      - main
      - auto-sync  # ä¹Ÿæµ‹è¯• auto-sync åˆ†æ”¯
    paths:
      - 'Formula/**'
  workflow_dispatch:

jobs:
  test-build:
    strategy:
      matrix:
        os:
          - macos-14      # Apple Silicon (M1/M2/M3/M4)
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout ä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Homebrew
        run: |
          echo "ğŸº Homebrew ç‰ˆæœ¬:"
          brew --version
          echo "è·³è¿‡ brew update ä»¥åŠ å¿«æµ‹è¯•é€Ÿåº¦"
      
      - name: è®¾ç½®æœ¬åœ° tap
        run: |
          # å°†å½“å‰ä»“åº“è®¾ç½®ä¸ºæœ¬åœ° tap
          REPO_PATH="${GITHUB_WORKSPACE}"
          TAP_PATH="$(brew --repository)/Library/Taps/hotwa/homebrew-woodpecker"
          
          echo "ğŸ“‚ åˆ›å»º tap ç›®å½•..."
          mkdir -p "$(dirname "$TAP_PATH")"
          ln -sf "$REPO_PATH" "$TAP_PATH"
          
          echo "âœ… Tap è®¾ç½®å®Œæˆ"
          ls -la "$TAP_PATH/Formula/" | head -10
      
      - name: æµ‹è¯• woodpecker-cli æ„å»º
        run: |
          echo "ğŸ“¦ æµ‹è¯•æ„å»º woodpecker-cli..."
          brew install --build-from-source --verbose hotwa/woodpecker/woodpecker-cli
          
          echo "âœ… éªŒè¯å®‰è£…..."
          woodpecker-cli --version || woodpecker --version
          
          echo "ğŸ§¹ æ¸…ç†..."
          brew uninstall woodpecker-cli
      
      - name: æµ‹è¯• woodpecker-plugin æ„å»º
        run: |
          echo "ğŸ“¦ æµ‹è¯•æ„å»º woodpecker-plugin-git..."
          brew install --build-from-source --verbose hotwa/woodpecker/woodpecker-plugin-git
          woodpecker-plugin-git --version
          brew uninstall woodpecker-plugin-git
          
          echo "ğŸ“¦ æµ‹è¯•æ„å»º woodpecker-plugin-s3..."
          brew install --build-from-source --verbose hotwa/woodpecker/woodpecker-plugin-s3
          woodpecker-plugin-s3 --version
          brew uninstall woodpecker-plugin-s3
          
          echo "ğŸ“¦ æµ‹è¯•æ„å»º woodpecker-plugin-docker-buildx..."
          brew install --build-from-source --verbose hotwa/woodpecker/woodpecker-plugin-docker-buildx
          woodpecker-plugin-docker-buildx --version
          brew uninstall woodpecker-plugin-docker-buildx
      
      - name: æµ‹è¯• woodpecker-agent æ„å»º
        run: |
          echo "ğŸ“¦ æµ‹è¯•æ„å»º woodpecker-agentï¼ˆå«æ‰€æœ‰ä¾èµ–ï¼‰..."
          brew install --build-from-source --verbose hotwa/woodpecker/woodpecker-agent
          
          echo "âœ… éªŒè¯å®‰è£…..."
          woodpecker-agent --version
          
          echo "âœ… æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          ls -la $(brew --prefix)/etc/woodpecker/
          
          echo "âœ… æ£€æŸ¥å¯åŠ¨è„šæœ¬..."
          ls -la $(brew --prefix)/share/woodpecker-agent/
          
          echo "ğŸ§¹ æ¸…ç†..."
          brew uninstall woodpecker-agent
      
      - name: è¾“å‡ºæ„å»ºä¿¡æ¯
        if: always()
        run: |
          echo "ğŸ“Š ç³»ç»Ÿä¿¡æ¯:"
          sw_vers
          echo ""
          echo "ğŸ”§ æ¶æ„: $(uname -m)"
          echo "ğŸ’» Go ç‰ˆæœ¬: $(brew list --versions go)"

