name: Auto Update Woodpecker Formulae

on:
  schedule:
    # æ¯å¤© UTC 02:00 æ£€æŸ¥ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿ç‰ˆæœ¬ç›¸åŒï¼‰'
        required: false
        default: 'false'
  push:
    branches:
      - auto-sync  # auto-sync åˆ†æ”¯æ¨é€æ—¶ä¹Ÿè§¦å‘

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout æœ¬ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: auto-sync  # æ£€å‡º auto-sync åˆ†æ”¯
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
        id: upstream
        run: |
          # è·å–æœ€æ–°çš„ release tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/woodpecker-ci/woodpecker/releases/latest | jq -r '.tag_name')
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "latest_version=${LATEST_TAG#v}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬: ${LATEST_TAG}"
          
          # è·å– main åˆ†æ”¯æœ€æ–° commitï¼ˆç”¨äº CLIï¼‰
          MAIN_COMMIT=$(git ls-remote https://github.com/woodpecker-ci/woodpecker.git refs/heads/main | cut -f1)
          echo "main_commit=${MAIN_COMMIT}" >> $GITHUB_OUTPUT
          echo "ğŸ”– Main åˆ†æ”¯ commit: ${MAIN_COMMIT}"
      
      - name: æ£€æŸ¥å½“å‰ç‰ˆæœ¬
        id: current
        run: |
          # ä» woodpecker-agent.rb æå–å½“å‰ç‰ˆæœ¬
          CURRENT_TAG=$(grep -E '^\s+tag:\s+' Formula/woodpecker-agent.rb | sed -E 's/.*"(.*)".*/\1/')
          echo "current_tag=${CURRENT_TAG}" >> $GITHUB_OUTPUT
          echo "current_version=${CURRENT_TAG#v}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ å½“å‰ç‰ˆæœ¬: ${CURRENT_TAG}"
          
          # ä» woodpecker-cli.rb æå–å½“å‰ commit
          CURRENT_COMMIT=$(grep -E '^\s+revision:\s+' Formula/woodpecker-cli.rb | sed -E 's/.*"(.*)".*/\1/')
          echo "current_commit=${CURRENT_COMMIT}" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ å½“å‰ CLI commit: ${CURRENT_COMMIT}"
      
      - name: æ¯”è¾ƒç‰ˆæœ¬
        id: compare
        run: |
          NEEDS_UPDATE=false
          CHANGES=""
          
          # æ£€æŸ¥ agent ç‰ˆæœ¬
          if [ "${{ steps.current.outputs.current_tag }}" != "${{ steps.upstream.outputs.latest_tag }}" ]; then
            NEEDS_UPDATE=true
            CHANGES="${CHANGES}â€¢ woodpecker-agent: ${{ steps.current.outputs.current_tag }} â†’ ${{ steps.upstream.outputs.latest_tag }}\n"
          fi
          
          # æ£€æŸ¥ CLI commit
          if [ "${{ steps.current.outputs.current_commit }}" != "${{ steps.upstream.outputs.main_commit }}" ]; then
            NEEDS_UPDATE=true
            CHANGES="${CHANGES}â€¢ woodpecker-cli: commit æ›´æ–°\n"
          fi
          
          # æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            NEEDS_UPDATE=true
            CHANGES="${CHANGES}â€¢ æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°\n"
          fi
          
          echo "needs_update=${NEEDS_UPDATE}" >> $GITHUB_OUTPUT
          echo -e "changes<<EOF" >> $GITHUB_OUTPUT
          echo -e "${CHANGES}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "${NEEDS_UPDATE}" == "true" ]; then
            echo "âœ… å‘ç°æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ›´æ–°"
          else
            echo "â„¹ï¸  å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
          fi
      
      - name: æ›´æ–° Formula æ–‡ä»¶
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          LATEST_TAG="${{ steps.upstream.outputs.latest_tag }}"
          LATEST_VERSION="${{ steps.upstream.outputs.latest_version }}"
          MAIN_COMMIT="${{ steps.upstream.outputs.main_commit }}"
          DATE_VERSION=$(date +%Y%m%d)
          
          # æ›´æ–° woodpecker-agent.rb
          echo "ğŸ“ æ›´æ–° woodpecker-agent.rb..."
          
          # è·å–å½“å‰ revision å¹¶é€’å¢
          CURRENT_REVISION=$(grep -E '^\s+revision\s+' Formula/woodpecker-agent.rb | sed -E 's/.*revision\s+([0-9]+).*/\1/')
          NEW_REVISION=$((CURRENT_REVISION + 1))
          
          # æ›´æ–° tag
          sed -i.bak -E "s|(tag:\s+)\".+\"|\1\"${LATEST_TAG}\"|" Formula/woodpecker-agent.rb
          
          # æ›´æ–° revision
          sed -i.bak -E "s|(revision\s+)[0-9]+|\1${NEW_REVISION}|" Formula/woodpecker-agent.rb
          
          # æ›´æ–° woodpecker-cli.rb
          echo "ğŸ“ æ›´æ–° woodpecker-cli.rb..."
          sed -i.bak -E "s|(revision:\s+)\".+\"|\1\"${MAIN_COMMIT}\"|" Formula/woodpecker-cli.rb
          sed -i.bak -E "s|(version\s+)\".+\"|\1\"${DATE_VERSION}\"|" Formula/woodpecker-cli.rb
          
          # æ¸…ç†å¤‡ä»½æ–‡ä»¶
          rm -f Formula/*.bak
          
          echo "âœ… Formula æ–‡ä»¶æ›´æ–°å®Œæˆ"
      
      - name: éªŒè¯ Formula è¯­æ³•
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          echo "ğŸ” æ£€æŸ¥ Ruby è¯­æ³•..."
          ruby -c Formula/woodpecker-agent.rb
          ruby -c Formula/woodpecker-cli.rb
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
      
      - name: æäº¤æ›´æ–°åˆ° auto-sync åˆ†æ”¯
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Formula/*.rb
          git commit -m "chore: è‡ªåŠ¨æ›´æ–° Woodpecker åˆ° ${{ steps.upstream.outputs.latest_tag }}

          è‡ªåŠ¨æ›´æ–°ä¸Šæ¸¸ç‰ˆæœ¬ï¼š
          ${{ steps.compare.outputs.changes }}
          
          - woodpecker-agent: ${{ steps.upstream.outputs.latest_tag }}
          - woodpecker-cli: commit ${{ steps.upstream.outputs.main_commit }}
          
          ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æäº¤åˆ° auto-sync åˆ†æ”¯"
          
          git push origin auto-sync
          
          echo "âœ… å·²æäº¤æ›´æ–°åˆ° auto-sync åˆ†æ”¯"
      
      - name: åˆ›å»º Pull Request åˆ° main
        if: steps.compare.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-sync
          base: main
          title: 'ğŸ¤– [auto-sync â†’ main] æ›´æ–° Woodpecker åˆ° ${{ steps.upstream.outputs.latest_tag }}'
          body: |
            ## ğŸ“¦ è‡ªåŠ¨ç‰ˆæœ¬æ›´æ–°
            
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œä» `auto-sync` åˆ†æ”¯åŒæ­¥åˆ° `main` åˆ†æ”¯ã€‚
            
            `auto-sync` åˆ†æ”¯å·²è‡ªåŠ¨æ›´æ–°åˆ°ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬ã€‚
            
            ### å˜æ›´å†…å®¹
            ${{ steps.compare.outputs.changes }}
            
            ### ä¸Šæ¸¸ä¿¡æ¯
            - **æœ€æ–°ç‰ˆæœ¬**: [${{ steps.upstream.outputs.latest_tag }}](https://github.com/woodpecker-ci/woodpecker/releases/tag/${{ steps.upstream.outputs.latest_tag }})
            - **Release é¡µé¢**: https://github.com/woodpecker-ci/woodpecker/releases/latest
            - **Changelog**: https://github.com/woodpecker-ci/woodpecker/releases/tag/${{ steps.upstream.outputs.latest_tag }}
            
            ### åˆ†æ”¯ç­–ç•¥
            - ğŸ”„ `auto-sync` åˆ†æ”¯ï¼šè‡ªåŠ¨è·Ÿéšä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
            - ğŸ¯ `main` åˆ†æ”¯ï¼šæ‰‹åŠ¨å®¡æ ¸åçš„ç¨³å®šç‰ˆæœ¬
            
            ### æµ‹è¯•å»ºè®®
            åˆå¹¶å‰è¯·åœ¨æœ¬åœ°æµ‹è¯• auto-sync åˆ†æ”¯ï¼š
            ```bash
            # åˆ‡æ¢åˆ° auto-sync åˆ†æ”¯
            git fetch origin
            git checkout auto-sync
            
            # æµ‹è¯•æ„å»º
            brew uninstall woodpecker-agent 2>/dev/null || true
            brew install --build-from-source ./Formula/woodpecker-agent.rb
            woodpecker-agent --version
            
            # æµ‹è¯•è¿è¡Œ
            brew services start woodpecker-agent
            sleep 5
            brew services stop woodpecker-agent
            
            # åˆ‡å› main
            git checkout main
            ```
            
            ### è‡ªåŠ¨æ£€æŸ¥
            - âœ… Ruby è¯­æ³•æ£€æŸ¥é€šè¿‡
            - âœ… å·²æäº¤åˆ° auto-sync åˆ†æ”¯
            - â³ ç­‰å¾…äººå·¥å®¡æ ¸åˆå¹¶åˆ° main
            
            ### å¦‚ä½•ä½¿ç”¨
            **ç”¨æˆ·å¦‚æœæƒ³ä½¿ç”¨æœ€æ–°ç‰ˆ**ï¼š
            ```bash
            # ä½¿ç”¨ auto-sync åˆ†æ”¯ï¼ˆæœ€æ–°ç‰ˆï¼‰
            brew tap hotwa/woodpecker https://github.com/hotwa/homebrew-woodpecker.git
            brew install hotwa/woodpecker/woodpecker-agent
            ```
            
            **ç”¨æˆ·å¦‚æœæƒ³ä½¿ç”¨ç¨³å®šç‰ˆ**ï¼š
            ```bash
            # ç­‰å¾…æ­¤ PR åˆå¹¶åˆ° main åä½¿ç”¨
            brew update
            brew upgrade woodpecker-agent
            ```
            
            ---
            ğŸ¤– ç”± [Auto Update Workflow](.github/workflows/auto-update.yml) è‡ªåŠ¨ç”Ÿæˆ
          labels: |
            automated
            dependencies
            enhancement
            auto-sync
      
      - name: è¾“å‡ºç»“æœ
        if: always()
        run: |
          if [ "${{ steps.compare.outputs.needs_update }}" == "true" ]; then
            echo "âœ… æˆåŠŸåˆ›å»ºæ›´æ–° PR"
          else
            echo "â„¹ï¸  æ— éœ€æ›´æ–°ï¼Œå½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi

